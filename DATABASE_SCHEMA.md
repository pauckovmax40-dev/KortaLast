# Схема Базы Данных (Supabase/PostgreSQL)

Данный документ описывает структуру базы данных для системы управления ремонтом электродвигателей. Все таблицы используют Row Level Security (RLS) и привязаны к `auth.users` через `user_id`.

## 1. Справочники и Основные Сущности

Эти таблицы служат для хранения базовых данных, необходимых для работы системы.

### `counterparties` (Контрагенты)
Хранит информацию о клиентах, поставщиках и партнерах.

| Поле | Тип | Описание | Примечания |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ | |
| `user_id` | `uuid` | Владелец записи | FK: `auth.users` |
| `name` | `text` | Название контрагента | UNIQUE INDEX |
| `code` | `text` | Внутренний код | |
| `contact_info` | `text` | Общая контактная информация | |
| `inn` | `text` | ИНН | UNIQUE INDEX (WHERE NOT NULL) |
| `kpp` | `text` | КПП | |
| `address` | `text` | Юридический адрес | |
| `contact_person` | `text` | Контактное лицо | |
| `phone` | `text` | Телефон | |
| `email` | `text` | Электронная почта | |
| `description` | `text` | Дополнительное описание | |
| `is_active` | `boolean` | Статус активности | DEFAULT `true` |
| `created_at` | `timestamptz` | Дата создания | |
| `updated_at` | `timestamptz` | Дата последнего обновления | Обновляется триггером |

### `subdivisions` (Подразделения)
Хранит информацию о внутренних подразделениях, цехах или локациях.

| Поле | Тип | Описание | Примечания |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ | |
| `user_id` | `uuid` | Владелец записи | FK: `auth.users` |
| `name` | `text` | Название подразделения | NOT NULL |
| `code` | `text` | Код подразделения | |
| `description` | `text` | Описание | |
| `created_at` | `timestamptz` | Дата создания | |

### `motors` (Двигатели)
Справочник моделей электродвигателей и их характеристик.

| Поле | Тип | Описание | Примечания |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ | |
| `user_id` | `uuid` | Владелец записи | FK: `auth.users` |
| `name` | `text` | Наименование модели | NOT NULL |
| `power_kw` | `numeric(8, 2)` | Мощность (кВт) | NOT NULL, DEFAULT 0 |
| `rpm` | `integer` | Обороты в минуту | NOT NULL, DEFAULT 0 |
| `voltage` | `integer` | Напряжение (В) | DEFAULT 380 |
| `current` | `numeric(8, 2)` | Ток (А) | DEFAULT 0 |
| `efficiency` | `numeric(5, 2)` | КПД (%) | DEFAULT 0 |
| `manufacturer` | `text` | Производитель | |
| `price_per_unit` | `numeric(12, 2)` | Цена за единицу | NOT NULL, DEFAULT 0 |
| `is_active` | `boolean` | Статус активности | DEFAULT `true` |
| `text` | `text` | Дополнительный текст/описание | |
| `created_at` | `timestamptz` | Дата создания | |
| `updated_at` | `timestamptz` | Дата последнего обновления | Обновляется триггером |

## 2. Приемка и Ремонт (Модуль Приемки)

Этот модуль управляет процессом регистрации двигателей, принятых в ремонт.

### `receptions` (Документы Приемки)
Заголовок документа, связывающий приемку с контрагентом.

| Поле | Тип | Описание | Связи |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ | |
| `reception_date` | `timestamptz` | Дата приемки | |
| `reception_number` | `text` | Номер документа | |
| `counterparty_id` | `uuid` | Контрагент | FK: `counterparties` (ON DELETE RESTRICT) |
| `user_id` | `uuid` | Владелец записи | FK: `auth.users` |

### `accepted_motors` (Принятые Двигатели)
Индивидуальный двигатель, принятый в рамках документа `receptions`. ID этой записи используется для генерации QR-кода.

| Поле | Тип | Описание | Связи |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ (QR Code ID) | |
| `reception_id` | `uuid` | Ссылка на документ приемки | FK: `receptions` (ON DELETE CASCADE) |
| `subdivision_id` | `uuid` | Подразделение, куда принят двигатель | FK: `subdivisions` (ON DELETE SET NULL) |
| `position_in_reception` | `int` | Позиция в документе приемки | NOT NULL |
| `motor_service_description` | `text` | Описание требуемого сервиса | NOT NULL |
| `user_id` | `uuid` | Владелец записи | FK: `auth.users` |

### `reception_items` (Позиции Приемки)
Детализация работ, необходимых для конкретного принятого двигателя. Эти позиции позже связываются с финансовым документом (UPD).

| Поле | Тип | Описание | Связи |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ | |
| `accepted_motor_id` | `uuid` | Ссылка на принятый двигатель | FK: `accepted_motors` (ON DELETE CASCADE) |
| `item_description` | `text` | Описание работы/услуги | NOT NULL |
| `work_group` | `text` | Группа работ | |
| `quantity` | `numeric` | Количество | DEFAULT 1 |
| `price` | `numeric` | Цена за единицу | DEFAULT 0 |
| `upd_document_id` | `uuid` | Ссылка на сформированный УПД | FK: `upd_documents` (NULLABLE) |
| `user_id` | `uuid` | Владелец записи | FK: `auth.users` |

## 3. Финансовые Документы (Модуль УПД)

Этот модуль управляет формированием Универсальных Передаточных Документов (УПД).

### `upd_documents` (Заголовки УПД)
Заголовок финансового документа.

| Поле | Тип | Описание | Связи |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ | |
| `user_id` | `uuid` | Владелец записи | FK: `auth.users` |
| `document_number` | `text` | Номер документа | |
| `counterparty_id` | `uuid` | Контрагент | FK: `counterparties` (ON DELETE RESTRICT) |
| `document_date` | `timestamptz` | Дата документа | |
| `total_income` | `numeric` | Общая сумма дохода | DEFAULT 0 |
| `total_expense` | `numeric` | Общая сумма расхода | DEFAULT 0 |
| `status` | `text` | Статус документа | DEFAULT 'Draft' |
| `subdivision_id` | `uuid` | Подразделение, формирующее документ | FK: `subdivisions` (ON DELETE RESTRICT) |

### `upd_document_items` (Позиции УПД)
Иерархические позиции внутри УПД.

| Поле | Тип | Описание | Связи |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | Первичный ключ | |
| `document_id` | `uuid` | Ссылка на заголовок УПД | FK: `upd_documents` (ON DELETE CASCADE) |
| `parent_id` | `uuid` | Ссылка на родительскую позицию | Self-referencing (ON DELETE CASCADE) |
| `level` | `integer` | Уровень иерархии (1: Position, 2: Subgroup, 3: Line) | NOT NULL |
| `order_index` | `integer` | Порядок сортировки | |
| `item_type` | `text` | Тип элемента (Position, Subgroup, Line) | NOT NULL |
| `description` | `text` | Описание позиции | NOT NULL |
| `quantity` | `numeric` | Количество | DEFAULT 1 |
| `price` | `numeric` | Цена за единицу | DEFAULT 0 |
| `is_income` | `boolean` | Доход/Расход | DEFAULT `true` |
| `motor_id` | `uuid` | Ссылка на модель двигателя (если применимо) | FK: `motors` (ON DELETE SET NULL) |
| `original_order_id` | `uuid` | Ссылка на старую таблицу `repair_orders` (DEPRECATED) | FK: `repair_orders` (ON DELETE SET NULL) |

## 4. Хранимые Процедуры (RPC)

### `create_upd_and_link_reception_items`

Эта функция обеспечивает атомарное создание нового документа УПД и связывание с ним выбранных позиций из приемки (`reception_items`).

**Назначение:** Транзакционное формирование финансового документа из списка принятых работ.

**Сигнатура:**
```sql
create_upd_and_link_reception_items(
    p_counterparty_id uuid,
    p_subdivision_id uuid,
    p_document_number text,
    p_document_date text,
    p_item_ids uuid[] -- Массив ID из reception_items
) RETURNS uuid
```

**Логика:**
1. Проверяет аутентификацию пользователя (`auth.uid()`).
2. Вставляет новую запись в `upd_documents`.
3. Обновляет все записи в `reception_items`, чьи ID содержатся в `p_item_ids`, устанавливая им `upd_document_id` на ID нового УПД.
4. Возвращает ID созданного документа УПД.

## 5. Безопасность (Row Level Security)

RLS включен на всех таблицах. Политики настроены таким образом, что аутентифицированный пользователь может выполнять CRUD операции только над теми записями, где `user_id` совпадает с его собственным ID (`auth.uid()`).

Для `upd_document_items` используется вспомогательная функция `check_document_owner` для проверки владения родительским документом (`upd_documents`).

---

## 6. Логика Работы Приложения и Взаимодействие с Supabase

Приложение структурировано вокруг трех основных модулей, каждый из которых взаимодействует с определенным набором таблиц через стандартные запросы (CRUD) или хранимые процедуры (RPC).

### 6.1. Модуль Справочников (Catalogs)

Этот модуль управляет базовыми данными, необходимыми для всей системы.

*   **Таблицы**: `counterparties`, `subdivisions`, `motors`.
*   **Взаимодействие**: Приложение выполняет стандартные операции `SELECT`, `INSERT`, `UPDATE`, `DELETE` для управления этими сущностями. Данные из этих таблиц используются для заполнения выпадающих списков и связывания документов (Приемка, УПД) с конкретными контрагентами, подразделениями или моделями двигателей.

### 6.2. Модуль Приемки (Reception Workflow)

Этот модуль регистрирует поступление двигателей в ремонт и детализирует необходимые работы.

1.  **Создание документа приемки**: Пользователь создает заголовок в таблице `receptions`, связывая его с контрагентом (`counterparty_id`).
2.  **Добавление двигателей**: Для каждого принятого двигателя создается запись в `accepted_motors`. Эта запись является уникальным идентификатором двигателя в ремонте (QR-код).
3.  **Детализация работ**: Для каждого двигателя добавляются позиции работ/услуг в таблицу `reception_items`.
    *   Критический момент: При создании, поле `upd_document_id` в `reception_items` остается **NULL**. Это означает, что работа выполнена, но еще не выставлена в финансовом документе.

### 6.3. Модуль Формирования УПД (Financial/UPD Workflow)

Этот модуль отвечает за выставление финансовых документов (УПД) на основе выполненных, но еще не оплаченных работ.

1.  **Выбор доступных работ**: Приложение запрашивает из Supabase все записи из `reception_items`, где `upd_document_id IS NULL` и которые принадлежат выбранному контрагенту.
2.  **Инициирование создания УПД**: Пользователь выбирает одну или несколько позиций работ (`reception_items.id`) и инициирует создание УПД.
3.  **Транзакционное сохранение (RPC)**: Приложение вызывает хранимую процедуру `create_upd_and_link_reception_items`.
    *   **Цель RPC**: Обеспечить атомарность операции: создать заголовок УПД и немедленно привязать к нему выбранные позиции приемки.
    *   **Результат**:
        *   Создается новая запись в `upd_documents`.
        *   Выбранные записи в `reception_items` обновляются, и их поле `upd_document_id` заполняется ID нового УПД.
4.  **Редактирование позиций УПД**: После создания заголовка УПД, пользователь может добавлять дополнительные, иерархические позиции в таблицу `upd_document_items` (например, для учета расходов или других финансовых операций, не связанных с приемкой).
    *   **Связь**: Позиции `upd_document_items` связаны с заголовком `upd_documents` через `document_id`.
    *   **RLS**: Безопасность RLS для `upd_document_items` проверяется через владение родительским документом (`upd_documents`).
